var RKCloudIM=function(){function e(a){var f=0;if(a.result&&a.result.msg){for(var d=0;d<a.result.msg.length;d++){var p=a.result.msg[d];RKCloudIM.log.debug(p);var c=p.ptype,e=p.sl;e>f&&(f=e);if(!(e<=v))try{if(1==c){c=p;RKCloudIM.log.debug("disposeChatMsg--msg:"+c);var p=c,u=c.type;if("MMS"==u){var q=new RKMessage;q.setChatType(RKChat.Type.SINGLE);q.setDirection(p.srcname==RKCloudIM.getUserName()?RKMessage.Direction.SEND:RKMessage.Direction.RECEIVE);q.setChatId(p.srcname==RKCloudIM.getUserName()?p.dest:
p.srcname);q.setMsgSerialNum(p.id);q.setSender(p.srcname);q.setCreatedTime((new Date).getTime()/1E3);q.setExtension(p.ext);u=p.mime.toUpperCase();q.setMsgType(u);if(RKMessage.Type.TEXT==u||RKMessage.Type.CUSTOM==u)q.setContent(p.text);else if(RKMessage.Type.IMAGE==u||RKMessage.Type.AUDIO==u||RKMessage.Type.VIDEO==u||RKMessage.Type.FILE==u)q.setFilePath(t+"/"+p.fp),q.setFileSize(p.size),q.setFileName(p.filename),RKMessage.Type.AUDIO!=u&&RKMessage.Type.VIDEO!=u||q.setDuration(p.duration),RKMessage.Type.IMAGE!=
u&&RKMessage.Type.VIDEO!=u||q.setThumbPath(t+"/"+p.fpthumb);void 0!=x&&x(q)}else if("GMG"==u){q=new RKMessage;q.setChatType(RKChat.Type.GROUP);q.setDirection(p.srcname==m?RKMessage.Direction.SEND:RKMessage.Direction.RECEIVE);q.setChatId(p.group);q.setMsgSerialNum(p.id);q.setSender(p.srcname);q.setCreatedTime((new Date).getTime()/1E3);q.setExtension(p.ext);u=p.mime.toUpperCase();q.setMsgType(u);if(RKMessage.Type.TEXT==u||RKMessage.Type.CUSTOM==u)q.setContent(p.text);else if(RKMessage.Type.IMAGE==u||
RKMessage.Type.AUDIO==u||RKMessage.Type.VIDEO==u||RKMessage.Type.FILE==u)q.setFilePath(t+"/"+p.fp),q.setThumbPath(t+"/"+p.fpthumb),q.setFileSize(p.size),q.setFileName(p.filename),RKMessage.Type.AUDIO!=u&&RKMessage.Type.VIDEO!=u||q.setDuration(p.duration);void 0!=x&&x(q)}else if("JMG"==u){if(void 0!=s&&void 0!=s.onUsersAddGroup){var g={account:p.srcname},c=[],k=p.join.split(","),e=void 0;for(e in k)c.push({account:k[e]});s.onUsersAddGroup(p.group,g,c)}}else if("LMG"==u){if(void 0!=s){var h=p.ltype;
if(3==h){if(void 0!=s.onGroupDismiss)s.onGroupDismiss(p.group)}else if(2==h||1==h){var l={account:p.leave,leaveType:h};if(void 0!=s.onUserLeaveGroup)s.onUserLeaveGroup(p.group,l)}}}else if("GUP"==u&&void 0!=s&&void 0!=s.onGroupInfoChanged)s.onGroupInfoChanged(p.group)}else 0==c&&null!=w&&(RKCloudIM.log.debug("disposePPMMsg--msg:"+p),"PPM"==p.type&&w(p.srcname,p.content,p.time))}catch(n){RKCloudIM.log.debug(n.message)}}0!=f?(v<f&&(RKCloudIM.log.debug("_maxSerial < tempMaxSerial:tempMaxSerial="+f),
v=f),b.getMessage(),RKCloudIM.log.debug("ackMessage serial="+f)):RKCloudIM.log.debug("ackMessage serial= 0 ")}else RKCloudIM.log.debug("no message ingore")}var n=0,m,r,h,B=50,z=100,y=2097152,g=60,D=10,k=1024,A=1024,v=0,x,w,l,s,t,b=function(){function a(a,f,d,c,q,e,g){RKCloudIM.log.debug("url = "+a);RKCloudIM.log.debug(f);var h=new XMLHttpRequest;if(null==h)alert("\u4e0d\u652f\u6301\u7684\u6d4f\u89c8\u5668\u7c7b\u578b\u3002");else{var k=null!=e&&e instanceof File?!0:!1;h.open(null==q?"POST":q,a,!0);
k||h.setRequestHeader("Content-Type","application/x-www-form-urlencoded");a="";k&&(a=new FormData,a.append("file",e),h.upload.onprogress=function(a){null!=g&&g(e,Math.floor(100*a.loaded/a.total))});for(var n in f)k?a.append(n,f[n]):a+=n+"="+encodeURIComponent(f[n]+"")+"&";h.send(a);h.onload=function(){if(200==h.status){if(null!=c&&(d==b.VALUE||d==b.MESSAGE)){RKCloudIM.log.debug(h.responseText);var a;a=JSON.parse(h.responseText);var f={errcode:0};if(a)if(a.result)f=a;else{var p={},C;for(C in a)"errcode"==
C?f.errcode=a.errcode:"errmsg"==C?f.errmsg=a.errmsg:p[C]=a[C];f.result=p}a=f;1011==a.errcode||1999==a.errcode?(RKCloudIM.log.debug("User is error. code="+a.errcode),null!=l&&(f=1,1011==a.errcode?f=1:1999==a.errcode&&(f=2),l(f)),RKCloudIM.unInit()):c(a)}}else null!=c&&c(RKCloudIM.RKCloudErrorCode.RK_FAILURE)};h.onerror=function(a){null!=c&&c(RKCloudIM.RKCloudErrorCode.RK_FAILURE)}}}var f,d="https://"+rkapi;return{MESSAGE:1,TEXT:2,VALUE:3,getProfile:function(b,f){if(null==b)return{result:RKCloudIM.RKCloudErrorCode.RK_FAILURE};
a(d+"/3.0/getProfile.do",b,this.VALUE,f)},getMessage:function(b){a(f+"/3.0/getMessage.do",{ss:h,sl:v,l:"500"},this.MESSAGE,e)},ackMessage:function(b){a(f+ACK_MESSAGE,{ss:h,serial:v},this.MESSAGE)},sendMsg:function(b,d,c,e,q){d.ss=h;d.ptype=1;a(f+(b?null!=e?"/3.0/sendGroupMms.do":"/3.0/sendGroupMessage.do":null!=e?"/3.0/sendMms.do":"/3.0/sendMessage.do"),d,this.VALUE,c,null,e,q)},getAllMyGroups:function(b,d){b.ss=h;b.ptype=1;a(f+"/3.0/getMyGroups.do",b,this.VALUE,d)},getGroupInfo:function(b,d){b.ss=
h;b.ptype=1;a(f+"/3.0/getGroupInfo.do",b,this.VALUE,d)},getGroupUsers:function(b,d){b.ss=h;b.ptype=1;a(f+"/3.0/getGroupMemberInfo.do",b,this.VALUE,d)},createGroup:function(b,d){b.ss=h;b.ptype=1;a(f+"/3.0/createGroup.do",b,this.VALUE,d)},inviteUsers:function(b,d){b.ss=h;b.ptype=1;a(f+"/3.0/inviteGroup.do",b,this.VALUE,d)},quitGroup:function(b,d){b.ss=h;b.ptype=1;a(f+"/3.0/leaveGroup.do",b,this.VALUE,d)},kickUser:function(b,d){b.ss=h;b.ptype=1;a(f+"/3.0/kickFromGroup.do",b,this.VALUE,d)},getLiveAddress:function(b,
d){b.ss=h;b.ptype=2;a(f+"/3.0/getLiveAddress.do",b,this.VALUE,d)},setApi:function(a){f=d}}}(),c={_client:null,_clientId:null,_lpsIp:null,_lpsPort:null,_lpsPwd:null,_reConnectInterval:null,_reConnectTimer:5E3,self:null,connect:function(a,b,d,c){RKCloudIM.log.debug("LPS connect. ip="+a+" port="+b+" clientId="+d+" ss="+c);self=this;this._clientId=d;this._lpsIp=a;this._lpsPort=b;this._lpsPwd=c;this._client=new Messaging.Client(this._lpsIp,this._lpsPort,this._clientId);this._client.onConnectionLost=this.onConnectionLost;
this._client.onMessageArrived=this.onMessageArrived;this._client.connect({keepAliveInterval:60,cleanSession:!0,userName:self._clientId+"",password:self._lpsPwd,useSSL:!0,onSuccess:function(){RKCloudIM.log.debug("onConnect");RKCloudIM.log.debug("subscribe to: "+self._clientId);setTimeout(function(){self._client.subscribe(self._clientId)},1E3);self.stopReconnect()},onFailure:function(a){RKCloudIM.log.debug("Connect fail. reson=");RKCloudIM.log.debug(a);8==a.errorCode&&(self.stopReconnect(),null!=l&&
l(1))}})},reconnect:function(){self.connect(self._lpsIp,self._lpsPort,self._clientId,self._lpsPwd)},startReconnect:function(){null!=self._lpsIp&&(RKCloudIM.log.debug("startReconnect"),null==self._reConnectInterval&&(RKCloudIM.log.debug("startReconnect interval"),self._reConnectInterval=setInterval(self.reconnect,self._reConnectTimer)))},stopReconnect:function(){RKCloudIM.log.debug("stopReconnect");clearInterval(self._reConnectInterval);self._reConnectInterval=null},onConnectionLost:function(a){RKCloudIM.log.debug("onConnectionLost errcode=: "+
a.errorCode+"errmessage="+a.errorMessage);0!==a.errorCode&&(RKCloudIM.log.debug("onConnectionLost: "+a.errorMessage),self.startReconnect())},onMessageArrived:function(a){RKCloudIM.log.debug("onMessageArrived: "+a.payloadString);a=a.payloadString.split("-");"NMN"==a[0]&&Number(a[1])>Number(v)?b.getMessage():RKCloudIM.log.debug("_maxSerial > NMN serial do not getMessage. ")},disconnect:function(){try{this._client.disconnect()}catch(a){}this._lpsPwd=this._clientId=this._lpsPort=this._lpsIp=this._client=
null}};return{init:function(a,f,d,p){if(void 0==a||null==a||0>=a.length||50<a.length||void 0==f||null==f||0>=f.length||50<f.length||void 0==d||null==d||0>=d.length||50<d.length){if(RKCloudIM.log.debug("init--some param is error."),void 0!=p&&void 0!=p.onFail)p.onFail(RKCloudIM.RKCloudErrorCode.RK_PARAMS_ERROR)}else 0!=n&&RKCloudIM.unInit(),n=1,m=a,_initCallBack=p,p=RKCloudIM.util.getBrowserInfo(),a={key:d,username:a,pwd:f,pkgnm:"com.rongkecloud.web",os:"webim",osv:"1.0",sdkver:RKCloudIM.getVersion(),
mf:p.browser,md:p.ver,cap:"1"},b.getProfile(a,function(a){RKCloudIM.log.debug(a);if(0==a.errcode){var d=a.result.lps.split(":");b.setApi("https://"+a.result.api);n=2;h=a.result.ss;t="http://"+a.result.fdfs;B=a.result.groupmax;z=a.result.attendeemax;y=a.result.mmsmax;setTimeout(b.getMessage(),50);r=a.result.uid;c.connect(d[0],Number(d[1]),a.result.uid,h);_initCallBack.onSuccess()}else d=RKCloudIM.RKCloudErrorCode.RK_FAILURE,1010==a.errcode?d=RKCloudIM.RKCloudErrorCode.BASE_ACCOUNT_PW_ERROR:1999==a.errcode?
d=RKCloudIM.RKCloudErrorCode.BASE_ACCOUNT_BANNED:1003==a.errcode&&(d=RKCloudIM.RKCloudErrorCode.BASE_APP_KEY_AUTH_FAIL),_initCallBack.onFail(d),n=0})},unInit:function(){RKCloudIM.log.debug("RKCloudIM un init.");n=0;h=r=null;B=50;z=100;y=2097152;g=60;D=10;A=k=1024;v=0;_RKCloudIM=t=s=l=w=x=_initCallBack=null;c.disconnect()},chat:new function(){this.sendMsg=function(a,f,d){if(RKCloudIM.isSDKInitSuccess())if(a instanceof RKMessage){if(void 0==a.getChatId()||null==a.getChatId()||0>=a.getChatId().length||
50<a.getChatId().length||RKChat.Type.SINGLE!=a.getChatType()&&RKChat.Type.GROUP!=a.getChatType()||a.getMsgType()!=RKMessage.Type.TEXT&&a.getMsgType()!=RKMessage.Type.IMAGE&&a.getMsgType()!=RKMessage.Type.AUDIO&&a.getMsgType()!=RKMessage.Type.VIDEO&&a.getMsgType()!=RKMessage.Type.FILE&&a.getMsgType()!=RKMessage.Type.CUSTOM||a.getDirection()!=RKMessage.Direction.SEND||void 0==a.getMsgSerialNum()||null==a.getMsgSerialNum()||0>=a.getMsgSerialNum().length||70<a.getMsgSerialNum().length||void 0==a.getSender()||
null==a.getSender()||0>=a.getSender().length||50<a.getSender().length||0>=a.getCreatedTime()||void 0!=a.getExtension()&&null!=a.getExtension()&&0<a.getExtension().length&&a.getExtension().length>RKCloudIM.getExtensionMaxLength()){RKCloudIM.log.debug("sendMsg--some param is null.");if(void 0!=f&&void 0!=f.onFail)f.onFail(RKCloudIM.RKCloudErrorCode.RK_PARAMS_ERROR);return null}if(RKChat.Type.SINGLE==a.getChatType()&&a.getChatId()==RKCloudIM.getUserName()){RKCloudIM.log.debug("sendMsg--forbid send mms to yourself.");
if(void 0!=f&&void 0!=f.onFail)f.onFail(RKCloudIM.RKCloudErrorCode.CHAT_MMS_CANNOT_SEND_OWN);return null}var c={mime:a.getMsgType().toLowerCase(),id:a.getMsgSerialNum(),ext:a.getExtension()};if(RKChat.Type.SINGLE==a.getChatType()){if(RKCloudIM.getUserName()==a.getChatId()){RKCloudIM.log.debug("sendMsg--forbid send msg to self.");if(void 0!=f&&void 0!=f.onFail)f.onFail(RKCloudIM.RKCloudErrorCode.RK_PARAMS_ERROR);return null}c.dest=a.getChatId()}else RKChat.Type.GROUP==a.getChatType()&&(c.gid=a.getChatId());
if(RKMessage.Type.TEXT==a.getMsgType()||RKMessage.Type.CUSTOM==a.getMsgType()){if(0>=a.getContent().length||a.getContent().length>RKCloudIM.getTextMaxLength()){RKCloudIM.log.debug("sendMsg--msg content's length limited 1 to "+RKCloudIM.getTextMaxLength());if(void 0!=f&&void 0!=f.onFail)f.onFail(RKCloudIM.RKCloudErrorCode.RK_PARAMS_ERROR);return null}c.text=a.getContent()}else{if(!(a.getFileWidgetObj()instanceof File)){RKCloudIM.log.debug("sendMsg--need attach file.");if(void 0!=f&&void 0!=f.onFail)f.onFail(RKCloudIM.RKCloudErrorCode.RK_PARAMS_ERROR);
return null}var e=a.getFileWidgetObj();if(e.size>RKCloudIM.getMediaMmsMaxSize()){RKCloudIM.log.debug("sendMsg--file's size beyond.");if(void 0!=f&&void 0!=f.onFail)f.onFail(RKCloudIM.RKCloudErrorCode.CHAT_MMS_SIZE_EXCEED_LIMIT);return null}var g=null;""!=e.type&&(g=e.type.split("/"),g[0]=g[0].toLowerCase(),g[1]=g[1].toLowerCase());if(RKMessage.Type.IMAGE==a.getMsgType()){if("image"!=g[0]||"jpg"!=g[1]&&"png"!=g[1]&&"jpeg"!=g[1]){RKCloudIM.log.debug("sendMsg--file's mime type unsupport.");if(void 0!=
f&&void 0!=f.onFail)f.onFail(RKCloudIM.RKCloudErrorCode.RK_PARAMS_ERROR);return null}}else if(RKMessage.Type.AUDIO==a.getMsgType()){if(0>=a.getDuration()||a.getDuration()>RKCloudIM.getAudioMmsMaxDuration()){RKCloudIM.log.debug("sendMsg--file's duration error.");if(void 0!=f&&void 0!=f.onFail)f.onFail(RKCloudIM.RKCloudErrorCode.RK_PARAMS_ERROR);return null}}else if(RKMessage.Type.VIDEO==a.getMsgType()&&(0>=a.getDuration()||a.getDuration()>RKCloudIM.getVideoMmsMaxDuration())){RKCloudIM.log.debug("sendMsg--file's duration error.");
if(void 0!=f&&void 0!=f.onFail)f.onFail(RKCloudIM.RKCloudErrorCode.RK_PARAMS_ERROR);return null}c.filename=e.name;c.size=e.size}b.sendMsg(RKChat.Type.GROUP==a.getChatType(),c,function(a){RKCloudIM.log.debug("sendMsg Result======================");RKCloudIM.log.debug(a);if(void 0!=f)if(0==a.errcode){if(void 0!=f.onSuccess)f.onSuccess(a.result.fileid)}else if(void 0!=f.onFail){var b=RKCloudIM.RKCloudErrorCode.RK_FAILURE;1006==a.errcode?b=RKCloudIM.RKCloudErrorCode.RK_INVALID_USER:3006==a.errcode?b=
RKCloudIM.RKCloudErrorCode.CHAT_GROUP_USER_NOT_EXIST:3004==a.errcode&&(b=RKCloudIM.RKCloudErrorCode.CHAT_GROUP_NOT_EXIST);f.onFail(b)}},a.getFileWidgetObj(),d)}else{if(RKCloudIM.log.debug("sendMsg--Illegal message object."),void 0!=f&&void 0!=f.onFail)f.onFail(RKCloudIM.RKCloudErrorCode.RK_PARAMS_ERROR)}else if(RKCloudIM.log.debug("sendMsg--sdk is not init."),void 0!=f&&void 0!=f.onFail)f.onFail(RKCloudIM.RKCloudErrorCode.RK_SDK_UNINIT)};this.getAllMyGroups=function(a){if(RKCloudIM.isSDKInitSuccess())b.getAllMyGroups({},
function(b){RKCloudIM.log.debug("getAllMyGroups Result======================");RKCloudIM.log.debug(b);if(void 0!=a)if(0==b.errcode){if(void 0!=a.onSuccess){var d=[];b=b.result;for(var c in b){var e=b[c];d.push({groupId:e.gid,groupName:e.gname,creator:e.owner,createdtime:e.created,totalUserCount:e.total,hasInviteAuth:e.invite})}a.onSuccess(d)}}else if(void 0!=a.onFail)a.onFail(RKCloudIM.RKCloudErrorCode.RK_FAILURE)});else if(RKCloudIM.log.debug("getAllMyGroups--sdk is not init."),void 0!=a&&void 0!=
a.onFail)a.onFail(RKCloudIM.RKCloudErrorCode.RK_SDK_UNINIT)};this.getGroupInfo=function(a,f){if(RKCloudIM.isSDKInitSuccess())if(void 0==a||null==a||0>=a.length||30<a.length){if(RKCloudIM.log.debug("getGroupInfo--some param is error."),void 0!=f&&void 0!=f.onFail)f.onFail(RKCloudIM.RKCloudErrorCode.RK_PARAMS_ERROR)}else b.getGroupInfo({gid:a},function(b){RKCloudIM.log.debug("getGroupInfo Result======================");RKCloudIM.log.debug(b);if(void 0!=f)if(0==b.errcode){if(void 0!=f.onSuccess)f.onSuccess({groupId:a,
groupName:b.result.gname,creator:b.result.owner,createdtime:b.result.created,totalUserCount:b.result.total,hasInviteAuth:b.result.invite})}else if(void 0!=f.onFail){var c=RKCloudIM.RKCloudErrorCode.RK_FAILURE;3004==b.errcode&&(c=RKCloudIM.RKCloudErrorCode.CHAT_GROUP_NOT_EXIST);f.onFail(c)}});else if(RKCloudIM.log.debug("getGroupInfo--sdk is not init."),void 0!=f&&void 0!=f.onFail)f.onFail(RKCloudIM.RKCloudErrorCode.RK_SDK_UNINIT)};this.getGroupUsers=function(a,f){if(RKCloudIM.isSDKInitSuccess())if(void 0==
a||null==a||0>=a.length||30<a.length){if(RKCloudIM.log.debug("getGroupUsers--some param is error."),void 0!=f&&void 0!=f.onFail)f.onFail(RKCloudIM.RKCloudErrorCode.RK_PARAMS_ERROR)}else b.getGroupUsers({gid:a},function(a){RKCloudIM.log.debug("getGroupUsers Result======================");RKCloudIM.log.debug(a);if(void 0!=f)if(0==a.errcode){if(void 0!=f.onSuccess)f.onSuccess(a.result)}else if(void 0!=f.onFail){var b=RKCloudIM.RKCloudErrorCode.RK_FAILURE;3004==a.errcode&&(b=RKCloudIM.RKCloudErrorCode.CHAT_GROUP_NOT_EXIST);
f.onFail(b)}});else if(RKCloudIM.log.debug("getGroupUsers--sdk is not init."),void 0!=f&&void 0!=f.onFail)f.onFail(RKCloudIM.RKCloudErrorCode.RK_SDK_UNINIT)};this.createGroup=function(a,f,d){if(RKCloudIM.isSDKInitSuccess())if(void 0==a||null==a||void 0==f||null==f||0>=f.length||30<f.length){if(RKCloudIM.log.debug("createGroup--some param is error."),void 0!=d&&void 0!=d.onFail)d.onFail(RKCloudIM.RKCloudErrorCode.RK_PARAMS_ERROR)}else{var c=0,e=a.split(","),g=[],h={},q;for(q in e){var k=e[q],k=RKCloudIM.util.trim(k);
if(0>=k.length){c=1;break}if(RKCloudIM.getUserName()==k){c=2;break}if(h[k]){c=3;break}g.push(k);h[k]=!0}if(0!=c){if(RKCloudIM.log.debug("createGroup--accounts are error, type:"+c),void 0!=d&&void 0!=d.onFail)d.onFail(RKCloudIM.RKCloudErrorCode.RK_PARAMS_ERROR)}else if(g.length>=RKCloudIM.getMaxNumOfGroupUsers()){if(RKCloudIM.log.debug("createGroup--accounts count beyond."),void 0!=d&&void 0!=d.onFail)d.onFail(RKCloudIM.RKCloudErrorCode.CHAT_GROUP_USER_NUMBER_EXCEED_LIMIT)}else b.createGroup({gname:f,
members:a},function(a){RKCloudIM.log.debug("createGroup Result======================");RKCloudIM.log.debug(a);if(void 0!=d)if(0==a.errcode){if(void 0!=d.onSuccess)d.onSuccess(a.result.gid)}else if(void 0!=d.onFail){var b=RKCloudIM.RKCloudErrorCode.RK_FAILURE;1006==a.errcode?b=RKCloudIM.RKCloudErrorCode.RK_INVALID_USER:3001==a.errcode?b=RKCloudIM.RKCloudErrorCode.CHAT_GROUP_USER_NUMBER_EXCEED_LIMIT:3002==a.errcode&&(b=RKCloudIM.RKCloudErrorCode.CHAT_GROUP_COUNT_EXCEED_LIMIT);d.onFail(b)}})}else if(RKCloudIM.log.debug("createGroup--sdk is not init."),
void 0!=d&&void 0!=d.onFail)d.onFail(RKCloudIM.RKCloudErrorCode.RK_SDK_UNINIT)};this.inviteUsers=function(a,c,d){if(RKCloudIM.isSDKInitSuccess())if(void 0==a||null==a||0>=a.length||30<a.length||void 0==c||null==c){if(RKCloudIM.log.debug("inviteUsers--some param is error."),void 0!=d&&void 0!=d.onFail)d.onFail(RKCloudIM.RKCloudErrorCode.RK_PARAMS_ERROR)}else{var e=0,g=c.split(","),h=[],k={},q;for(q in g){var l=g[q],l=RKCloudIM.util.trim(l);if(0>=l.length){e=1;break}if(RKCloudIM.getUserName()==l){e=
2;break}if(k[l]){e=3;break}h.push(l);k[l]=!0}if(0!=e){if(RKCloudIM.log.debug("inviteUsers--accounts are error, type:"+e),void 0!=d&&void 0!=d.onFail)d.onFail(RKCloudIM.RKCloudErrorCode.RK_PARAMS_ERROR)}else if(h.length>=RKCloudIM.getMaxNumOfGroupUsers()){if(RKCloudIM.log.debug("inviteUsers--accounts count beyond."),void 0!=d&&void 0!=d.onFail)d.onFail(RKCloudIM.RKCloudErrorCode.CHAT_GROUP_USER_NUMBER_EXCEED_LIMIT)}else b.inviteUsers({gid:a,members:c},function(a){RKCloudIM.log.debug("inviteUsers Result======================");
RKCloudIM.log.debug(a);if(void 0!=d)if(0==a.errcode){if(void 0!=d.onSuccess)d.onSuccess()}else if(void 0!=d.onFail){var b=RKCloudIM.RKCloudErrorCode.RK_FAILURE;1006==a.errcode?b=RKCloudIM.RKCloudErrorCode.RK_INVALID_USER:3001==a.errcode?b=RKCloudIM.RKCloudErrorCode.CHAT_GROUP_USER_NUMBER_EXCEED_LIMIT:3004==a.errcode?b=RKCloudIM.RKCloudErrorCode.CHAT_GROUP_NOT_EXIST:3009==a.errcode?b=RKCloudIM.RKCloudErrorCode.CHAT_GROUP_UNAUTH_INVITE:3006==a.errcode&&(b=RKCloudIM.RKCloudErrorCode.CHAT_GROUP_USER_NOT_EXIST);
d.onFail(b)}})}else if(RKCloudIM.log.debug("inviteUsers--sdk is not init."),void 0!=d&&void 0!=d.onFail)d.onFail(RKCloudIM.RKCloudErrorCode.RK_SDK_UNINIT)};this.kickUser=function(a,c,d){if(RKCloudIM.isSDKInitSuccess())if(void 0==a||null==a||0>=a.length||30<a.length||void 0==c||null==c||0>=c.length||50<c.length){if(RKCloudIM.log.debug("kickUser--some param is error."),void 0!=d&&void 0!=d.onFail)d.onFail(RKCloudIM.RKCloudErrorCode.RK_PARAMS_ERROR)}else b.kickUser({gid:a,member:c},function(a){RKCloudIM.log.debug("kickUser Result======================");
RKCloudIM.log.debug(a);if(void 0!=d)if(0==a.errcode){if(void 0!=d.onSuccess)d.onSuccess()}else if(void 0!=d.onFail){var b=RKCloudIM.RKCloudErrorCode.RK_FAILURE;3004==a.errcode?b=RKCloudIM.RKCloudErrorCode.CHAT_GROUP_NOT_EXIST:3008==a.errcode?b=RKCloudIM.RKCloudErrorCode.CHAT_GROUP_UNAUTH_KICKUSER:3006==a.errcode&&(b=RKCloudIM.RKCloudErrorCode.CHAT_GROUP_USER_NOT_EXIST);d.onFail(b)}});else if(RKCloudIM.log.debug("kickUser--sdk is not init."),void 0!=d&&void 0!=d.onFail)d.onFail(RKCloudIM.RKCloudErrorCode.RK_SDK_UNINIT)};
this.quitGroup=function(a,c){if(RKCloudIM.isSDKInitSuccess())if(void 0==a||null==a||0>=a.length||30<a.length){if(RKCloudIM.log.debug("quitGroup--some param is error."),void 0!=c&&void 0!=c.onFail)c.onFail(RKCloudIM.RKCloudErrorCode.RK_PARAMS_ERROR)}else b.quitGroup({gid:a},function(a){RKCloudIM.log.debug("quitGroup Result======================");RKCloudIM.log.debug(a);if(void 0!=c)if(0==a.errcode){if(void 0!=c.onSuccess)c.onSuccess()}else if(void 0!=c.onFail)c.onFail(RKCloudIM.RKCloudErrorCode.RK_FAILURE)});
else if(RKCloudIM.log.debug("quitGroup--sdk is not init."),void 0!=c&&void 0!=c.onFail)c.onFail(RKCloudIM.RKCloudErrorCode.RK_SDK_UNINIT)};this.setMessageReceivedCallback=function(a){x=a};this.setGroupCallback=function(a){s=a}},getVersion:function(){return"1.0.1"},getUserName:function(){return m},isSDKInitSuccess:function(){return 2==n},getMediaMmsMaxSize:function(){return y},getMaxNumOfGroupUsers:function(){return z},getMaxNumOfCreateGroups:function(){return B},getAudioMmsMaxDuration:function(){return g},
getVideoMmsMaxDuration:function(){return D},getTextMaxLength:function(){return k},getExtensionMaxLength:function(){return A},getUid:function(){return r},getLiveAddress:function(a,c){b.getLiveAddress(a,c)},setOnRKCloudFatalExceptionCallBack:function(a){l=a},setOnRKCloudReceivedUserDefinedMsgCallBack:function(a){w=a}}}();
RKCloudIM.chat.Message=function(){this.setChatId=function(e){this._chatId=void 0!=e&&null!=e?e:""};this.getChatId=function(){return void 0!=this._chatId&&null!=this._chatId?this._chatId:""};this.setChatType=function(e){var n=!1,m;for(m in RKChat.Type)if(e==RKChat.Type[m]){n=!0;break}this._chatType=n?e:""};this.getChatType=function(){return void 0!=this._chatType&&null!=this._chatType?this._chatType:""};this.setMsgSerialNum=function(e){this._msgSerialNum=void 0!=e&&null!=e?e:""};this.getMsgSerialNum=
function(){return void 0!=this._msgSerialNum&&null!=this._msgSerialNum?this._msgSerialNum:""};this.setSender=function(e){this._sender=void 0!=e&&null!=e?e:""};this.getSender=function(){return void 0!=this._sender&&null!=this._sender?this._sender:""};this.setDirection=function(e){var n=!1,m;for(m in RKMessage.Direction)if(e==RKMessage.Direction[m]){n=!0;break}this._direction=n?e:""};this.getDirection=function(){return void 0!=this._direction&&null!=this._direction?this._direction:""};this.setMsgType=
function(e){var n=!1,m;for(m in RKMessage.Type)if(e==RKMessage.Type[m]){n=!0;break}this._msgType=n?e:""};this.getMsgType=function(){return void 0!=this._msgType&&null!=this._msgType?this._msgType:""};this.setCreatedTime=function(e){this._createdTime=void 0!=e&&null!=e?Number(e):0};this.getCreatedTime=function(){return void 0!=this._createdTime&&null!=this._createdTime?this._createdTime:0};this.setContent=function(e){this._content=void 0!=e&&null!=e?e:""};this.getContent=function(){return void 0!=
this._content&&null!=this._content?this._content:""};this.setExtension=function(e){this._extension=void 0!=e&&null!=e&&e.length<=RKCloudIM.getExtensionMaxLength()?e:""};this.getExtension=function(){return void 0!=this._extension&&null!=this._extension?this._extension:""};this.setFilePath=function(e){this._filePath=void 0!=e&&null!=e?e:""};this.getFilePath=function(){return void 0!=this._filePath&&null!=this._filePath?this._filePath:""};this.setFileSize=function(e){this._fileSize=void 0!=e&&null!=
e?Number(e):0};this.getFileSize=function(){return void 0!=this._fileSize&&null!=this._fileSize?this._fileSize:0};this.setFileName=function(e){this._fileName=void 0!=e&&null!=e?e:""};this.getFileName=function(){return void 0!=this._fileName&&null!=this._fileName?this._fileName:""};this.setDuration=function(e){this._duration=void 0!=e&&null!=e?Number(e):0};this.getDuration=function(){return void 0!=this._duration&&null!=this._duration?this._duration:0};this.setFileWidgetObj=function(e){this._fileWidgetObj=
e};this.getFileWidgetObj=function(){return this._fileWidgetObj};this.setThumbPath=function(e){this._thumbPath=e};this.getThumbPath=function(){return this._thumbPath}};RKCloudIM.chat.Type={SINGLE:"SINGLE",GROUP:"GROUP"};RKCloudIM.chat.Message.Direction={SEND:"send",RECEIVE:"receive"};RKCloudIM.chat.Message.Type={TEXT:"TEXT",IMAGE:"IMAGE",AUDIO:"AUDIO",VIDEO:"VIDEO",FILE:"FILE",CUSTOM:"CUSTOM"};RKCloudIM.chat.Message._lastSecondTimeStamp=0;RKCloudIM.chat.Message._lastRandomInt=0;
RKCloudIM.chat.Message.createMsgSerialNum=function(){var e=Date.parse(new Date)/1E3;this._lastSecondTimeStamp!=e&&(this._lastSecondTimeStamp=e,this._lastRandomInt=0);this._lastRandomInt++;e=RKCloudIM.getUserName()+"-"+this._lastSecondTimeStamp+"-";0<this._lastRandomInt&&10>this._lastRandomInt?e+="00":10<=this._lastRandomInt&&100>this._lastRandomInt&&(e+="0");return e+=this._lastRandomInt};
RKCloudIM.chat.Message.obtainTextMessage=function(e,n,m,r){if(void 0==e||null==e||void 0==n||null==n||50<n.length||void 0==m||null==m)return RKCloudIM.log.debug("obtainTextMessage--some param is null."),null;var h=new RKMessage;h.setChatId(n);h.setChatType(e);h.setMsgSerialNum(RKMessage.createMsgSerialNum());h.setDirection(RKMessage.Direction.SEND);h.setMsgType(RKMessage.Type.TEXT);h.setSender(RKCloudIM.getUserName());h.setContent(m);h.setCreatedTime(Date.parse(new Date)/1E3);h.setExtension(r);return h};
RKCloudIM.chat.Message.obtainImageMessage=function(e,n,m,r){if(void 0==e||null==e||void 0==n||null==n||!m instanceof File)return RKCloudIM.log.debug("obtainImageMessage--some param is null."),null;if(m.size>RKCloudIM.getMediaMmsMaxSize())return RKCloudIM.log.debug("obtainImageMessage--file's size beyond."),null;var h=new RKMessage;h.setChatId(n);h.setChatType(e);h.setMsgSerialNum(RKMessage.createMsgSerialNum());h.setDirection(RKMessage.Direction.SEND);h.setMsgType(RKMessage.Type.IMAGE);h.setSender(RKCloudIM.getUserName());
h.setCreatedTime(Date.parse(new Date)/1E3);h.setFileName(m.name);h.setFileSize(m.size);h.setFileWidgetObj(m);h.setExtension(r);return h};
RKCloudIM.chat.Message.obtainFileMessage=function(e,n,m,r){if(void 0==e||null==e||void 0==n||null==n||!m instanceof File)return RKCloudIM.log.debug("obtainFileMessage--some param is null."),null;if(m.size>RKCloudIM.getMediaMmsMaxSize())return RKCloudIM.log.debug("obtainFileMessage--file's size beyond."),null;var h=new RKMessage;h.setChatId(n);h.setChatType(e);h.setMsgSerialNum(RKMessage.createMsgSerialNum());h.setDirection(RKMessage.Direction.SEND);h.setMsgType(RKMessage.Type.FILE);h.setSender(RKCloudIM.getUserName());
h.setCreatedTime(Date.parse(new Date)/1E3);h.setFileName(m.name);h.setFileSize(m.size);h.setFileWidgetObj(m);h.setExtension(r);return h};
RKCloudIM.chat.Message.obtainCustomMessage=function(e,n,m){if(void 0==e||null==e||void 0==n||null==n||void 0==m||null==m)return RKCloudIM.log.debug("obtainCustomMessage--some param is null."),null;var r=new RKMessage;r.setChatId(n);r.setChatType(e);r.setMsgSerialNum(RKMessage.createMsgSerialNum());r.setDirection(RKMessage.Direction.SEND);r.setMsgType(RKMessage.Type.CUSTOM);r.setSender(RKCloudIM.getUserName());r.setContent(m);r.setCreatedTime(Date.parse(new Date)/1E3);return r};RKMessage=RKCloudIM.chat.Message;
RKChat=RKCloudIM.chat;RKCloudIM.RKCloudErrorCode={RK_SUCCESS:0,RK_FAILURE:1,RK_PARAMS_ERROR:3,RK_SDK_UNINIT:4,RK_INVALID_USER:5,BASE_APP_KEY_AUTH_FAIL:1001,BASE_ACCOUNT_PW_ERROR:1003,BASE_ACCOUNT_BANNED:1004,CHAT_MMS_SIZE_EXCEED_LIMIT:2003,CHAT_MMS_CANNOT_SEND_OWN:2005,CHAT_GROUP_NOT_EXIST:2021,CHAT_GROUP_USER_NOT_EXIST:2022,CHAT_GROUP_COUNT_EXCEED_LIMIT:2023,CHAT_GROUP_USER_NUMBER_EXCEED_LIMIT:2024,CHAT_GROUP_UNAUTH_INVITE:2026,CHAT_GROUP_UNAUTH_KICKUSER:2027};
RKCloudIM.log={DEBUG:!1,debug:function(e){this.DEBUG&&console.log(RKCloudIM.util.dateFormat(new Date,"yyyy-MM-dd hh:mm:ss")," : ",e)},setDebugMode:function(e){this.DEBUG=e}};
RKCloudIM.util={trim:function(e){return void 0==e||null==e?"":e.replace(/(^\s*)|(\s*$)/g,"")},dateFormat:function(e,n){var m={"M+":e.getMonth()+1,"d+":e.getDate(),"h+":0==e.getHours()%12?12:e.getHours()%12,"H+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),S:e.getMilliseconds()},r={0:"/u65e5",1:"/u4e00",2:"/u4e8c",3:"/u4e09",4:"/u56db",5:"/u4e94",6:"/u516d"};/(y+)/.test(n)&&(n=n.replace(RegExp.$1,(e.getFullYear()+"").substr(4-RegExp.$1.length)));/(E+)/.test(n)&&
(n=n.replace(RegExp.$1,(1<RegExp.$1.length?2<RegExp.$1.length?"/u661f/u671f":"/u5468":"")+r[e.getDay()+""]));for(var h in m)RegExp("("+h+")").test(n)&&(n=n.replace(RegExp.$1,1==RegExp.$1.length?m[h]:("00"+m[h]).substr((""+m[h]).length)));return n},getBrowserInfo:function(){return{}}};Messaging=function(e){function n(b,c,a){c[a++]=b>>8;c[a++]=b%256;return a}function m(b,c,a,f){f=n(c,a,f);h(b,a,f);return f+c}function r(b){for(var c=0,a=0;a<b.length;a++){var f=b.charCodeAt(a);2047<f?(55296<=f&&56319>=f&&(a++,c++),c+=3):127<f?c+=2:c++}return c}function h(b,c,a){for(var f=0;f<b.length;f++){var d=b.charCodeAt(f);if(55296<=d&&56319>=d){lowCharCode=b.charCodeAt(++f);if(isNaN(lowCharCode))throw Error(k(g.MALFORMED_UNICODE,[d,lowCharCode]));d=(d-55296<<10)+(lowCharCode-56320)+65536}127>=
d?c[a++]=d:(2047>=d?c[a++]=d>>6&31|192:(65535>=d?c[a++]=d>>12&15|224:(c[a++]=d>>18&7|240,c[a++]=d>>12&63|128),c[a++]=d>>6&63|128),c[a++]=d&63|128)}return c}function B(b,c,a){for(var f="",d,e=c;e<c+a;){d=b[e++];if(!(128>d)){var h=b[e++]-128;if(0>h)throw Error(k(g.MALFORMED_UTF,[d.toString(16),h.toString(16),""]));if(224>d)d=64*(d-192)+h;else{var l=b[e++]-128;if(0>l)throw Error(k(g.MALFORMED_UTF,[d.toString(16),h.toString(16),l.toString(16)]));if(240>d)d=4096*(d-224)+64*h+l;else{var n=b[e++]-128;if(0>
n)throw Error(k(g.MALFORMED_UTF,[d.toString(16),h.toString(16),l.toString(16),n.toString(16)]));if(248>d)d=262144*(d-240)+4096*h+64*l+n;else throw Error(k(g.MALFORMED_UTF,[d.toString(16),h.toString(16),l.toString(16),n.toString(16)]));}}}65535<d&&(d-=65536,f+=String.fromCharCode(55296+(d>>10)),d=56320+(d&1023));f+=String.fromCharCode(d)}return f}var z=function(b,c){for(key in b)if(b.hasOwnProperty(key))if(c.hasOwnProperty(key)){if(typeof b[key]!==c[key])throw Error(k(g.INVALID_TYPE,[typeof b[key],
key]));}else{var a="Unknown property, "+key+". Valid properties are:";for(key in c)c.hasOwnProperty(key)&&(a=a+" "+key);throw Error(a);}},y=function(b,c){return function(){return b.apply(c,arguments)}},g={OK:{code:0,text:"AMQJSC0000I OK."},CONNECT_TIMEOUT:{code:1,text:"AMQJSC0001E Connect timed out."},SUBSCRIBE_TIMEOUT:{code:2,text:"AMQJS0002E Subscribe timed out."},UNSUBSCRIBE_TIMEOUT:{code:3,text:"AMQJS0003E Unsubscribe timed out."},PING_TIMEOUT:{code:4,text:"AMQJS0004E Ping timed out."},INTERNAL_ERROR:{code:5,
text:"AMQJS0005E Internal error."},CONNACK_RETURNCODE:{code:6,text:"AMQJS0006E Bad Connack return code:{0} {1}."},SOCKET_ERROR:{code:7,text:"AMQJS0007E Socket error:{0}."},SOCKET_CLOSE:{code:8,text:"AMQJS0008I Socket closed."},MALFORMED_UTF:{code:9,text:"AMQJS0009E Malformed UTF data:{0} {1} {2}."},UNSUPPORTED:{code:10,text:"AMQJS0010E {0} is not supported by this browser."},INVALID_STATE:{code:11,text:"AMQJS0011E Invalid state {0}."},INVALID_TYPE:{code:12,text:"AMQJS0012E Invalid type {0} for {1}."},
INVALID_ARGUMENT:{code:13,text:"AMQJS0013E Invalid argument {0} for {1}."},UNSUPPORTED_OPERATION:{code:14,text:"AMQJS0014E Unsupported operation."},INVALID_STORED_DATA:{code:15,text:"AMQJS0015E Invalid data in local storage key={0} value={1}."},INVALID_MQTT_MESSAGE_TYPE:{code:16,text:"AMQJS0016E Invalid MQTT message type {0}."},MALFORMED_UNICODE:{code:17,text:"AMQJS0017E Malformed Unicode string:{0} {1}."}},D={0:"Connection Accepted",1:"Connection Refused: unacceptable protocol version",2:"Connection Refused: identifier rejected",
3:"Connection Refused: server unavailable",4:"Connection Refused: bad user name or password",5:"Connection Refused: not authorized"},k=function(b,c){var a=b.text;if(c)for(var f=0;f<c.length;f++)if(field="{"+f+"}",start=a.indexOf(field),0<start)var d=a.substring(0,start),a=a.substring(start+field.length),a=d+c[f]+a;return a},A=[0,6,77,81,73,115,100,112,3],v=function(b,c){this.type=b;for(name in c)c.hasOwnProperty(name)&&(this[name]=c[name])};v.prototype.encode=function(){var b=(this.type&15)<<4;remLength=
0;topicStrLength=[];void 0!=this.messageIdentifier&&(remLength+=2);switch(this.type){case 1:remLength+=A.length+3;remLength+=r(this.clientId)+2;if(void 0!=this.willMessage){remLength+=r(this.willMessage.destinationName)+2;var c=this.willMessage.payloadBytes;c instanceof Uint8Array||(c=new Uint8Array(f));remLength+=c.byteLength+2}void 0!=this.userName&&(remLength+=r(this.userName)+2);void 0!=this.password&&(remLength+=r(this.password)+2);break;case 8:for(var b=b|2,a=0;a<this.topics.length;a++)topicStrLength[a]=
r(this.topics[a]),remLength+=topicStrLength[a]+2;remLength+=this.requestedQos.length;break;case 10:b|=2;for(a=0;a<this.topics.length;a++)topicStrLength[a]=r(this.topics[a]),remLength+=topicStrLength[a]+2;break;case 3:this.payloadMessage.duplicate&&(b|=8);b=b|=this.payloadMessage.qos<<1;this.payloadMessage.retained&&(b|=1);destinationNameLength=r(this.payloadMessage.destinationName);remLength+=destinationNameLength+2;var f=this.payloadMessage.payloadBytes;remLength+=f.byteLength;f instanceof ArrayBuffer?
f=new Uint8Array(f):f instanceof Uint8Array||(f=new Uint8Array(f.buffer))}var d=remLength,a=Array(1),e=0;do{var g=d%128,d=d>>7;0<d&&(g|=128);a[e++]=g}while(0<d&&4>e);d=a.length+1;e=new ArrayBuffer(remLength+d);g=new Uint8Array(e);g[0]=b;g.set(a,1);3==this.type?d=m(this.payloadMessage.destinationName,destinationNameLength,g,d):1==this.type&&(g.set(A,d),d+=A.length,b=0,this.cleanSession&&(b=2),void 0!=this.willMessage&&(b=b|4|this.willMessage.qos<<3,this.willMessage.retained&&(b|=32)),void 0!=this.userName&&
(b|=128),void 0!=this.password&&(b|=64),g[d++]=b,d=n(this.keepAliveInterval,g,d));void 0!=this.messageIdentifier&&(d=n(this.messageIdentifier,g,d));switch(this.type){case 1:d=m(this.clientId,r(this.clientId),g,d);void 0!=this.willMessage&&(d=m(this.willMessage.destinationName,r(this.willMessage.destinationName),g,d),d=n(c.byteLength,g,d),g.set(c,d),d+=c.byteLength);void 0!=this.userName&&(d=m(this.userName,r(this.userName),g,d));void 0!=this.password&&m(this.password,r(this.password),g,d);break;case 3:g.set(f,
d);break;case 8:for(a=0;a<this.topics.length;a++)d=m(this.topics[a],topicStrLength[a],g,d),g[d++]=this.requestedQos[a];break;case 10:for(a=0;a<this.topics.length;a++)d=m(this.topics[a],topicStrLength[a],g,d)}return e};var x=function(b,c,a){this._client=b;this._window=c;this._keepAliveInterval=1E3*a;this.isReset=!1;var f=(new v(12)).encode(),d=function(a){return function(){return e.apply(a)}},e=function(){this.isReset?(this.isReset=!1,this._client._trace("Pinger.doPing","send PINGREQ"),this._client.socket.send(f),
this.timeout=this._window.setTimeout(d(this),this._keepAliveInterval)):(this._client._trace("Pinger.doPing","Timed out"),this._client._disconnected(g.PING_TIMEOUT.code,k(g.PING_TIMEOUT)))};this.reset=function(){this.isReset=!0;this._window.clearTimeout(this.timeout);0<this._keepAliveInterval&&(this.timeout=setTimeout(d(this),this._keepAliveInterval))};this.cancel=function(){this._window.clearTimeout(this.timeout)}},w=function(b,c,a,f,d){this._window=c;a||(a=30);this.timeout=setTimeout(function(a,
b,c){return function(){return a.apply(b,c)}}(f,b,d),1E3*a);this.cancel=function(){this._window.clearTimeout(this.timeout)}},l=function(b,c,a,f,d){if(!("WebSocket"in e&&null!==e.WebSocket))throw Error(k(g.UNSUPPORTED,["WebSocket"]));if(!("localStorage"in e&&null!==e.localStorage))throw Error(k(g.UNSUPPORTED,["localStorage"]));if(!("ArrayBuffer"in e&&null!==e.ArrayBuffer))throw Error(k(g.UNSUPPORTED,["ArrayBuffer"]));this._trace("Messaging.Client",b,c,a,f,d);this.host=c;this.port=a;this.path=f;this.uri=
b;this.clientId=d;this._localKey=c+":"+a+("/mqtt"!=f?":"+f:"")+":"+d+":";this._msg_queue=[];this._sentMessages={};this._receivedMessages={};this._notify_msg_sent={};this._message_identifier=1;this._sequence=0;for(key in localStorage)0!=key.indexOf("Sent:"+this._localKey)&&0!=key.indexOf("Received:"+this._localKey)||this.restore(key)};l.prototype.host;l.prototype.port;l.prototype.path;l.prototype.uri;l.prototype.clientId;l.prototype.socket;l.prototype.connected=!1;l.prototype.maxMessageIdentifier=
65536;l.prototype.connectOptions;l.prototype.hostIndex;l.prototype.onConnectionLost;l.prototype.onMessageDelivered;l.prototype.onMessageArrived;l.prototype._msg_queue=null;l.prototype._connectTimeout;l.prototype.sendPinger=null;l.prototype.receivePinger=null;l.prototype.receiveBuffer=null;l.prototype._traceBuffer=null;l.prototype._MAX_TRACE_ENTRIES=100;l.prototype.connect=function(b){var c=this._traceMask(b,"password");this._trace("Client.connect",c,this.socket,this.connected);if(this.connected)throw Error(k(g.INVALID_STATE,
["already connected"]));if(this.socket)throw Error(k(g.INVALID_STATE,["already connected"]));this.connectOptions=b;b.uris?(this.hostIndex=0,this._doConnect(b.uris[0])):this._doConnect(this.uri)};l.prototype.subscribe=function(b,c){this._trace("Client.subscribe",b,c);if(!this.connected)throw Error(k(g.INVALID_STATE,["not connected"]));var a=new v(8);a.topics=[b];a.requestedQos=void 0!=c.qos?[c.qos]:[0];c.onSuccess&&(a.callback=function(){c.onSuccess({invocationContext:c.invocationContext})});c.timeout&&
(a.timeOut=new w(this,window,c.timeout,c.onFailure,[{invocationContext:c.invocationContext,errorCode:g.SUBSCRIBE_TIMEOUT.code,errorMessage:k(g.SUBSCRIBE_TIMEOUT)}]));this._requires_ack(a);this._schedule_message(a)};l.prototype.unsubscribe=function(b,c){this._trace("Client.unsubscribe",b,c);if(!this.connected)throw Error(k(g.INVALID_STATE,["not connected"]));var a=new v(10);a.topics=[b];c.onSuccess&&(a.callback=function(){c.onSuccess({invocationContext:c.invocationContext})});c.timeout&&(a.timeOut=
new w(this,window,c.timeout,c.onFailure,[{invocationContext:c.invocationContext,errorCode:g.UNSUBSCRIBE_TIMEOUT.code,errorMessage:k(g.UNSUBSCRIBE_TIMEOUT)}]));this._requires_ack(a);this._schedule_message(a)};l.prototype.send=function(b){this._trace("Client.send",b);if(!this.connected)throw Error(k(g.INVALID_STATE,["not connected"]));wireMessage=new v(3);wireMessage.payloadMessage=b;0<b.qos?this._requires_ack(wireMessage):this.onMessageDelivered&&(this._notify_msg_sent[wireMessage]=this.onMessageDelivered(wireMessage.payloadMessage));
this._schedule_message(wireMessage)};l.prototype.disconnect=function(){this._trace("Client.disconnect");if(!this.socket)throw Error(k(g.INVALID_STATE,["not connecting or connected"]));wireMessage=new v(14);this._notify_msg_sent[wireMessage]=y(this._disconnected,this);this._schedule_message(wireMessage)};l.prototype.getTraceLog=function(){if(null!==this._traceBuffer){this._trace("Client.getTraceLog",new Date);this._trace("Client.getTraceLog in flight messages",this._sentMessages.length);for(key in this._sentMessages)this._trace("_sentMessages ",
key,this._sentMessages[key]);for(key in this._receivedMessages)this._trace("_receivedMessages ",key,this._receivedMessages[key]);return this._traceBuffer}};l.prototype.startTrace=function(){null===this._traceBuffer&&(this._traceBuffer=[]);this._trace("Client.startTrace",new Date,"0.4.1-SNAPSHOT")};l.prototype.stopTrace=function(){delete this._traceBuffer};l.prototype._doConnect=function(b){this.connectOptions.useSSL&&(b=b.split(":"),b[0]="wss",b=b.join(":"));this.connected=!1;this.socket=new WebSocket(b,
"mqttv3.1");this.socket.binaryType="arraybuffer";this.socket.onopen=y(this._on_socket_open,this);this.socket.onmessage=y(this._on_socket_message,this);this.socket.onerror=y(this._on_socket_error,this);this.socket.onclose=y(this._on_socket_close,this);this.sendPinger=new x(this,window,this.connectOptions.keepAliveInterval);this.receivePinger=new x(this,window,this.connectOptions.keepAliveInterval);this._connectTimeout=new w(this,window,this.connectOptions.timeout,this._disconnected,[g.CONNECT_TIMEOUT.code,
k(g.CONNECT_TIMEOUT)])};l.prototype._schedule_message=function(b){this._msg_queue.push(b);this.connected&&this._process_queue()};l.prototype.store=function(b,c){storedMessage={type:c.type,messageIdentifier:c.messageIdentifier,version:1};switch(c.type){case 3:c.pubRecReceived&&(storedMessage.pubRecReceived=!0);storedMessage.payloadMessage={};for(var a="",f=c.payloadMessage.payloadBytes,d=0;d<f.length;d++)a=15>=f[d]?a+"0"+f[d].toString(16):a+f[d].toString(16);storedMessage.payloadMessage.payloadHex=
a;storedMessage.payloadMessage.qos=c.payloadMessage.qos;storedMessage.payloadMessage.destinationName=c.payloadMessage.destinationName;c.payloadMessage.duplicate&&(storedMessage.payloadMessage.duplicate=!0);c.payloadMessage.retained&&(storedMessage.payloadMessage.retained=!0);0==b.indexOf("Sent:")&&(void 0===c.sequence&&(c.sequence=++this._sequence),storedMessage.sequence=c.sequence);break;default:throw Error(k(g.INVALID_STORED_DATA,[key,storedMessage]));}localStorage.setItem(b+this._localKey+c.messageIdentifier,
JSON.stringify(storedMessage))};l.prototype.restore=function(b){var c=localStorage.getItem(b),a=JSON.parse(c),f=new v(a.type,a);switch(a.type){case 3:for(var c=a.payloadMessage.payloadHex,d=new ArrayBuffer(c.length/2),d=new Uint8Array(d),e=0;2<=c.length;){var h=parseInt(c.substring(0,2),16),c=c.substring(2,c.length);d[e++]=h}c=new Messaging.Message(d);c.qos=a.payloadMessage.qos;c.destinationName=a.payloadMessage.destinationName;a.payloadMessage.duplicate&&(c.duplicate=!0);a.payloadMessage.retained&&
(c.retained=!0);f.payloadMessage=c;break;default:throw Error(k(g.INVALID_STORED_DATA,[b,c]));}0==b.indexOf("Sent:"+this._localKey)?this._sentMessages[f.messageIdentifier]=f:0==b.indexOf("Received:"+this._localKey)&&(this._receivedMessages[f.messageIdentifier]=f)};l.prototype._process_queue=function(){for(var b=null,c=this._msg_queue.reverse();b=c.pop();)this._socket_send(b),this._notify_msg_sent[b]&&(this._notify_msg_sent[b](),delete this._notify_msg_sent[b])};l.prototype._requires_ack=function(b){var c=
Object.keys(this._sentMessages).length;if(c>this.maxMessageIdentifier)throw Error("Too many messages:"+c);for(;void 0!==this._sentMessages[this._message_identifier];)this._message_identifier++;b.messageIdentifier=this._message_identifier;this._sentMessages[b.messageIdentifier]=b;3===b.type&&this.store("Sent:",b);this._message_identifier===this.maxMessagIdentifier&&(this._message_identifier=1)};l.prototype._on_socket_open=function(){var b=new v(1,this.connectOptions);b.clientId=this.clientId;this._socket_send(b)};
l.prototype._on_socket_message=function(b){this._trace("Client._on_socket_message",b.data);this.receivePinger.reset();b=this._deframeMessages(b.data);for(var c=0;c<b.length;c+=1)this._handleMessage(b[c])};l.prototype._deframeMessages=function(b){b=new Uint8Array(b);if(this.receiveBuffer){var c=new Uint8Array(this.receiveBuffer.length+b.length);c.set(this.receiveBuffer);c.set(b,this.receiveBuffer.length);b=c;delete this.receiveBuffer}try{for(var c=0,a=[];c<b.length;){var f;a:{var d=b,e=c,h=e,l=d[e],
n=l>>4,q=l&15,e=e+1,m=void 0,r=0,s=1;do{if(e==d.length){f=[null,h];break a}m=d[e++];r+=(m&127)*s;s*=128}while(0!=(m&128));m=e+r;if(m>d.length)f=[null,h];else{var t=new v(n);switch(n){case 2:t.topicNameCompressionResponse=d[e++];t.returnCode=d[e++];break;case 3:var h=q>>1&3,x=256*d[e]+d[e+1],e=e+2,y=B(d,e,x),e=e+x;0<h&&(t.messageIdentifier=256*d[e]+d[e+1],e+=2);var w=new Messaging.Message(d.subarray(e));1==(q&1)&&(w.retained=!0);8==(q&8)&&(w.duplicate=!0);w.qos=h;w.destinationName=y;t.payloadMessage=
w;break;case 4:case 5:case 6:case 7:case 11:t.messageIdentifier=256*d[e]+d[e+1];break;case 9:t.messageIdentifier=256*d[e]+d[e+1],e+=2,t.grantedQos=d.subarray(e)}f=[t,m]}}var z=f[0],c=f[1];if(null!==z)a.push(z);else break}c<b.length&&(this.receiveBuffer=b.subarray(c))}catch(A){this._disconnected(g.INTERNAL_ERROR.code,k(g.INTERNAL_ERROR,[A.message]));return}return a};l.prototype._handleMessage=function(b){this._trace("Client._handleMessage",b);try{switch(b.type){case 2:this._connectTimeout.cancel();
if(this.connectOptions.cleanSession){for(key in this._sentMessages){var c=this._sentMessages[key];localStorage.removeItem("Sent:"+this._localKey+c.messageIdentifier)}this._sentMessages={};for(key in this._receivedMessages){var a=this._receivedMessages[key];localStorage.removeItem("Received:"+this._localKey+a.messageIdentifier)}this._receivedMessages={}}if(0===b.returnCode)this.connected=!0,this.connectOptions.uris&&(this.hostIndex=this.connectOptions.uris.length);else{this._disconnected(g.CONNACK_RETURNCODE.code,
k(g.CONNACK_RETURNCODE,[b.returnCode,D[b.returnCode]]));break}b=[];for(var f in this._sentMessages)this._sentMessages.hasOwnProperty(f)&&b.push(this._sentMessages[f]);b=b.sort(function(a,b){return a.sequence-b.sequence});f=0;for(var d=b.length;f<d;f++)if(c=b[f],3==c.type&&c.pubRecReceived){var e=new v(6,{messageIdentifier:c.messageIdentifier});this._schedule_message(e)}else this._schedule_message(c);if(this.connectOptions.onSuccess)this.connectOptions.onSuccess({invocationContext:this.connectOptions.invocationContext});
this._process_queue();break;case 3:this._receivePublish(b);break;case 4:if(c=this._sentMessages[b.messageIdentifier])if(delete this._sentMessages[b.messageIdentifier],localStorage.removeItem("Sent:"+this._localKey+b.messageIdentifier),this.onMessageDelivered)this.onMessageDelivered(c.payloadMessage);break;case 5:if(c=this._sentMessages[b.messageIdentifier])c.pubRecReceived=!0,e=new v(6,{messageIdentifier:b.messageIdentifier}),this.store("Sent:",c),this._schedule_message(e);break;case 6:a=this._receivedMessages[b.messageIdentifier];
localStorage.removeItem("Received:"+this._localKey+b.messageIdentifier);a&&(this._receiveMessage(a),delete this._receivedMessages[b.messageIdentifier]);pubCompMessage=new v(7,{messageIdentifier:b.messageIdentifier});this._schedule_message(pubCompMessage);break;case 7:c=this._sentMessages[b.messageIdentifier];delete this._sentMessages[b.messageIdentifier];localStorage.removeItem("Sent:"+this._localKey+b.messageIdentifier);if(this.onMessageDelivered)this.onMessageDelivered(c.payloadMessage);break;case 9:if(c=
this._sentMessages[b.messageIdentifier])c.timeOut&&c.timeOut.cancel(),c.callback&&c.callback(),delete this._sentMessages[b.messageIdentifier];break;case 11:if(c=this._sentMessages[b.messageIdentifier])c.timeOut&&c.timeOut.cancel(),c.callback&&c.callback(),delete this._sentMessages[b.messageIdentifier];break;case 13:this.sendPinger.reset();break;case 14:this._disconnected(g.INVALID_MQTT_MESSAGE_TYPE.code,k(g.INVALID_MQTT_MESSAGE_TYPE,[b.type]));break;default:this._disconnected(g.INVALID_MQTT_MESSAGE_TYPE.code,
k(g.INVALID_MQTT_MESSAGE_TYPE,[b.type]))}}catch(h){this._disconnected(g.INTERNAL_ERROR.code,k(g.INTERNAL_ERROR,[h.message]))}};l.prototype._on_socket_error=function(b){this._disconnected(g.SOCKET_ERROR.code,k(g.SOCKET_ERROR,[b.data]))};l.prototype._on_socket_close=function(){this._disconnected(g.SOCKET_CLOSE.code,k(g.SOCKET_CLOSE))};l.prototype._socket_send=function(b){if(1==b.type){var c=this._traceMask(b,"password");this._trace("Client._socket_send",c)}else this._trace("Client._socket_send",b);
this.socket.send(b.encode());this.sendPinger.reset()};l.prototype._receivePublish=function(b){switch(b.payloadMessage.qos){case "undefined":case 0:this._receiveMessage(b);break;case 1:var c=new v(4,{messageIdentifier:b.messageIdentifier});this._schedule_message(c);this._receiveMessage(b);break;case 2:this._receivedMessages[b.messageIdentifier]=b;this.store("Received:",b);b=new v(5,{messageIdentifier:b.messageIdentifier});this._schedule_message(b);break;default:throw Error("Invaild qos="+wireMmessage.payloadMessage.qos);
}};l.prototype._receiveMessage=function(b){if(this.onMessageArrived)this.onMessageArrived(b.payloadMessage)};l.prototype._disconnected=function(b,c){this._trace("Client._disconnected",b,c);this.sendPinger.cancel();this.receivePinger.cancel();this._connectTimeout&&this._connectTimeout.cancel();this._msg_queue=[];this._notify_msg_sent={};this.socket&&(this.socket.onopen=null,this.socket.onmessage=null,this.socket.onerror=null,this.socket.onclose=null,1===this.socket.readyState&&this.socket.close(),
delete this.socket);if(this.connectOptions.uris&&this.hostIndex<this.connectOptions.uris.length-1)this.hostIndex++,this._doConnect(this.connectOptions.uris[this.hostIndex]);else if(void 0===b&&(b=g.OK.code,c=k(g.OK)),this.connected){if(this.connected=!1,this.onConnectionLost)this.onConnectionLost({errorCode:b,errorMessage:c})}else if(this.connectOptions.onFailure)this.connectOptions.onFailure({invocationContext:this.connectOptions.invocationContext,errorCode:b,errorMessage:c})};l.prototype._trace=
function(){if(null!==this._traceBuffer)for(var b=0,c=arguments.length;b<c;b++)this._traceBuffer.length==this._MAX_TRACE_ENTRIES&&this._traceBuffer.shift(),0===b?this._traceBuffer.push(arguments[b]):"undefined"===typeof arguments[b]?this._traceBuffer.push(arguments[b]):this._traceBuffer.push("  "+JSON.stringify(arguments[b]))};l.prototype._traceMask=function(b,c){var a={},f;for(f in b)b.hasOwnProperty(f)&&(a[f]=f==c?"******":b[f]);return a};var s=function(b,c,a,f){var d;if("string"!==typeof b)throw Error(k(g.INVALID_TYPE,
[typeof b,"host"]));if(2==arguments.length){f=c;d=b;var e=d.match(/^(wss?):\/\/((\[(.+)\])|([^\/]+?))(:(\d+))?(\/.*)$/);if(e)b=e[4]||e[2],c=parseInt(e[7]),a=e[8];else throw Error(k(g.INVALID_ARGUMENT,[b,"host"]));}else{3==arguments.length&&(f=a,a="/mqtt");if("number"!==typeof c||0>c)throw Error(k(g.INVALID_TYPE,[typeof c,"port"]));if("string"!==typeof a)throw Error(k(g.INVALID_TYPE,[typeof a,"path"]));d="ws://"+(-1!=b.indexOf(":")?"["+b+"]":b)+":"+c+a}for(var h=e=0;h<f.length;h++){var n=f.charCodeAt(h);
55296<=n&&56319>=n&&h++;e++}if("string"!==typeof f||1>e|23<e)throw Error(k(g.INVALID_ARGUMENT,[f,"clientId"]));var m=new l(d,b,c,a,f);this._getHost=function(){return b};this._setHost=function(){throw Error(k(g.UNSUPPORTED_OPERATION));};this._getPort=function(){return c};this._setPort=function(){throw Error(k(g.UNSUPPORTED_OPERATION));};this._getPath=function(){return a};this._setPath=function(){throw Error(k(g.UNSUPPORTED_OPERATION));};this._getURI=function(){return d};this._setURI=function(){throw Error(k(g.UNSUPPORTED_OPERATION));
};this._getClientId=function(){return m.clientId};this._setClientId=function(){throw Error(k(g.UNSUPPORTED_OPERATION));};this._getOnConnectionLost=function(){return m.onConnectionLost};this._setOnConnectionLost=function(a){if("function"===typeof a)m.onConnectionLost=a;else throw Error(k(g.INVALID_TYPE,[typeof a,"onConnectionLost"]));};this._getOnMessageDelivered=function(){return m.onMessageDelivered};this._setOnMessageDelivered=function(a){if("function"===typeof a)m.onMessageDelivered=a;else throw Error(k(g.INVALID_TYPE,
[typeof a,"onMessageDelivered"]));};this._getOnMessageArrived=function(){return m.onMessageArrived};this._setOnMessageArrived=function(a){if("function"===typeof a)m.onMessageArrived=a;else throw Error(k(g.INVALID_TYPE,[typeof a,"onMessageArrived"]));};this.connect=function(a){a=a||{};z(a,{timeout:"number",userName:"string",password:"string",willMessage:"object",keepAliveInterval:"number",cleanSession:"boolean",useSSL:"boolean",invocationContext:"object",onSuccess:"function",onFailure:"function",hosts:"object",
ports:"object"});void 0===a.keepAliveInterval&&(a.keepAliveInterval=60);if(a.willMessage){if(!(a.willMessage instanceof t))throw Error(k(g.INVALID_TYPE,[a.willMessage,"connectOptions.willMessage"]));a.willMessage.stringPayload;if("undefined"===typeof a.willMessage.destinationName)throw Error(k(g.INVALID_TYPE,[typeof a.willMessage.destinationName,"connectOptions.willMessage.destinationName"]));}"undefined"===typeof a.cleanSession&&(a.cleanSession=!0);if(a.hosts){if(!(a.hosts instanceof Array))throw Error(k(g.INVALID_ARGUMENT,
[a.hosts,"connectOptions.hosts"]));if(1>a.hosts.length)throw Error(k(g.INVALID_ARGUMENT,[a.hosts,"connectOptions.hosts"]));for(var b=!1,c=0;c<a.hosts.length;c++){if("string"!==typeof a.hosts[c])throw Error(k(g.INVALID_TYPE,[typeof a.hosts[c],"connectOptions.hosts["+c+"]"]));if(/^(wss?):\/\/((\[(.+)\])|([^\/]+?))(:(\d+))?(\/.*)$/.test(a.hosts[c]))if(0==c)b=!0;else{if(!b)throw Error(k(g.INVALID_ARGUMENT,[a.hosts[c],"connectOptions.hosts["+c+"]"]));}else if(b)throw Error(k(g.INVALID_ARGUMENT,[a.hosts[c],
"connectOptions.hosts["+c+"]"]));}if(b)a.uris=a.hosts;else{if(!a.ports)throw Error(k(g.INVALID_ARGUMENT,[a.ports,"connectOptions.ports"]));if(!(a.ports instanceof Array))throw Error(k(g.INVALID_ARGUMENT,[a.ports,"connectOptions.ports"]));if(a.hosts.length!=a.ports.length)throw Error(k(g.INVALID_ARGUMENT,[a.ports,"connectOptions.ports"]));a.uris=[];for(c=0;c<a.hosts.length;c++){if("number"!==typeof a.ports[c]||0>a.ports[c])throw Error(k(g.INVALID_TYPE,[typeof a.ports[c],"connectOptions.ports["+c+"]"]));
var b=a.hosts[c],e=a.ports[c];d="ws://"+(-1!=b.indexOf(":")?"["+b+"]":b)+":"+e+"/mqtt";a.uris.push(d)}}}m.connect(a)};this.subscribe=function(a,b){if("string"!==typeof a)throw Error("Invalid argument:"+a);b=b||{};z(b,{qos:"number",invocationContext:"object",onSuccess:"function",onFailure:"function",timeout:"number"});if(b.timeout&&!b.onFailure)throw Error("subscribeOptions.timeout specified with no onFailure callback.");if("undefined"!==typeof b.qos&&0!==b.qos&&1!==b.qos&&2!==b.qos)throw Error(k(g.INVALID_ARGUMENT,
[b.qos,"subscribeOptions.qos"]));m.subscribe(a,b)};this.unsubscribe=function(a,b){if("string"!==typeof a)throw Error("Invalid argument:"+a);b=b||{};z(b,{invocationContext:"object",onSuccess:"function",onFailure:"function",timeout:"number"});if(b.timeout&&!b.onFailure)throw Error("unsubscribeOptions.timeout specified with no onFailure callback.");m.unsubscribe(a,b)};this.send=function(a){if(!(a instanceof t))throw Error("Invalid argument:"+typeof a);if("undefined"===typeof a.destinationName)throw Error("Invalid parameter Message.destinationName:"+
a.destinationName);m.send(a)};this.disconnect=function(){m.disconnect()};this.getTraceLog=function(){return m.getTraceLog()};this.startTrace=function(){m.startTrace()};this.stopTrace=function(){m.stopTrace()}};s.prototype={};s.prototype.__defineGetter__("host",function(){return this._getHost()});s.prototype.__defineSetter__("host",function(b){this._setHost(b)});s.prototype.__defineGetter__("port",function(){return this._getPort()});s.prototype.__defineSetter__("port",function(b){this._setPort(b)});
s.prototype.__defineGetter__("path",function(){return this._getPath()});s.prototype.__defineSetter__("path",function(b){this._setPath(b)});s.prototype.__defineGetter__("clientId",function(){return this._getClientId()});s.prototype.__defineSetter__("clientId",function(b){this._setClientId(b)});s.prototype.__defineGetter__("onConnectionLost",function(){return this._getOnConnectionLost()});s.prototype.__defineSetter__("onConnectionLost",function(b){this._setOnConnectionLost(b)});s.prototype.__defineGetter__("onMessageDelivered",
function(){return this._getOnMessageDelivered()});s.prototype.__defineSetter__("onMessageDelivered",function(b){this._setOnMessageDelivered(b)});s.prototype.__defineGetter__("onMessageArrived",function(){return this._getOnMessageArrived()});s.prototype.__defineSetter__("onMessageArrived",function(b){this._setOnMessageArrived(b)});var t=function(b){var c;if("string"===typeof b||b instanceof ArrayBuffer||b instanceof Int8Array||b instanceof Uint8Array||b instanceof Int16Array||b instanceof Uint16Array||
b instanceof Int32Array||b instanceof Uint32Array||b instanceof Float32Array||b instanceof Float64Array)c=b;else throw k(g.INVALID_ARGUMENT,[b,"newPayload"]);this._getPayloadString=function(){return"string"===typeof c?c:B(c,0,c.length)};this._getPayloadBytes=function(){if("string"===typeof c){var a=new ArrayBuffer(r(c)),a=new Uint8Array(a);h(c,a,0);return a}return c};var a=void 0;this._getDestinationName=function(){return a};this._setDestinationName=function(b){if("string"===typeof b)a=b;else throw Error(k(g.INVALID_ARGUMENT,
[b,"newDestinationName"]));};var e=0;this._getQos=function(){return e};this._setQos=function(a){if(0===a||1===a||2===a)e=a;else throw Error("Invalid argument:"+a);};var d=!1;this._getRetained=function(){return d};this._setRetained=function(a){if("boolean"===typeof a)d=a;else throw Error(k(g.INVALID_ARGUMENT,[a,"newRetained"]));};var l=!1;this._getDuplicate=function(){return l};this._setDuplicate=function(a){l=a}};t.prototype={};t.prototype.__defineGetter__("payloadString",function(){return this._getPayloadString()});
t.prototype.__defineSetter__("payloadBytes",function(){return this._getPayloadBytes()});t.prototype.__defineGetter__("destinationName",function(){return this._getDestinationName()});t.prototype.__defineSetter__("destinationName",function(b){this._setDestinationName(b)});t.prototype.__defineGetter__("qos",function(){return this._getQos()});t.prototype.__defineSetter__("qos",function(b){this._setQos(b)});t.prototype.__defineGetter__("retained",function(){return this._getRetained()});t.prototype.__defineSetter__("retained",
function(b){this._setRetained(b)});t.prototype.__defineGetter__("duplicate",function(){return this._getDuplicate()});t.prototype.__defineSetter__("duplicate",function(b){this._setDuplicate(b)});return{Client:s,Message:t}}(window);
